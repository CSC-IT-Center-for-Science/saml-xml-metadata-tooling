<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<title>Publish</title>

	<script src="//code.jquery.com/jquery-2.2.4.min.js"></script>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous" />
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous" />
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"
      type="text/css"  />
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
	<script src="//www.jsviews.com/download/jsrender.js"></script>
	<style>
	.glyphicon-spin {
    	-webkit-animation: spin 1000ms infinite linear;
    	animation: spin 1000ms infinite linear;
	}
	@-webkit-keyframes spin {
	  0% {
	    -webkit-transform: rotate(0deg);
	    transform: rotate(0deg);
	  }
	  100% {
	    -webkit-transform: rotate(359deg);
	    transform: rotate(359deg);
	  }
	}
	@keyframes spin {
	  0% {
	    -webkit-transform: rotate(0deg);
	    transform: rotate(0deg);
	  }
	  100% {
	    -webkit-transform: rotate(359deg);
	    transform: rotate(359deg);
	  }
	}	
	</style>
</head>
<body>

<div class="container">
	<div class="row">
	<div class="col-md-12">
		<h1>Publish process</h1>
	</div>
	</div>
	<div class="col-md-12">
		<h2>1. Import signed metadata file</h2>
	</div>
	<div class="col-sm-12">
		<form 
			class="form-inline" 
			id='importFrm'
			style="border-top: 1px dotted gainsboro; border-bottom: 1px dotted gainsboro; padding: 0.5em;">
			<div class="form-group">
				<input type="file" id="importFile" name="importFile">
			</div>
			<button 
				type="submit" 
				class="btn btn-default" 
				id="submitImportFile"
				data-loading-text="<span class='glyphicon glyphicon-refresh glyphicon-spin' aria-hidden='true'></span>" 
				data-done-text="<span style='color: green;' class='glyphicon glyphicon-ok' aria-hidden='true'></span>"
				data-error-text="<span class='glyphicon glyphicon-remove' aria-hidden='true'></span>"
				>Submit</button>
		</form>
	</div>

	<div class="row"  id='prePublishTests' style="display: none;">
	<div class="col-md-12">
		<h2>2. Run pre-publish tests</h2>
	</div>
	<div class="col-md-2">
		<button 
			type="submit"
			class="btn btn-default opReq"
			data-loading-text="<span class='glyphicon glyphicon-refresh glyphicon-spin' aria-hidden='true'></span>" 
			data-done-text="<span style='color: green;' class='glyphicon glyphicon-ok' aria-hidden='true'></span>"
			data-error-text="<span class='glyphicon glyphicon-remove' aria-hidden='true'></span>"
			>prePublishChecks</button>
	</div>
	<div class="col-md-10">
		<table class="table" style='width: auto;'>
			<thead>
				<tr>
					<td style='font-weight: bold; background-color: ghostwhite; border-top-left-radius: 15px;'>check</td>
					<td style='font-weight: bold; background-color: ghostwhite; border-top-right-radius: 15px;'>status</td>
				</tr>
			</thead>
			<tbody id='validateResults'></tbody>
		</table>
		
	</div>
	</div>
	
	<div class="row"  id='runDiff' style="display: none;">
	<div class="col-md-12">
		<h2>3. Run diff</h2>
	<div class="col-md-12" id="change">
	</div>
	</div>
	</div>
	
	<div class="row"  id='publish' style="display: none;">
	<div class="col-md-12">
		<h2>4. Publish</h2>
	</div>
	<div class="col-md-2">
		<button 
			type="submit"
			class="btn btn-default opReq"
			data-loading-text="<span class='glyphicon glyphicon-refresh glyphicon-spin' aria-hidden='true'></span>" 
			data-done-text="<span style='color: green;' class='glyphicon glyphicon-ok' aria-hidden='true'></span>"
			data-error-text="<span class='glyphicon glyphicon-remove' aria-hidden='true'></span>"
			>publish</button>
		
	</div>
	<div class="col-md-10">
		<table class="table" style='width: auto;'>
			<thead>
				<tr>
					<td style='font-weight: bold; background-color: ghostwhite; border-top-left-radius: 15px;'>runSecs</td>
					<td style='font-weight: bold; background-color: ghostwhite; border-top-right-radius: 15px;'>status</td>
				</tr>
			</thead>
			<tbody id='processStatus'></tbody>
		</table>
	</div>
	<div class="col-md-12" id='publishOutput'>
	</div>
	
	</div>

	<div class="row"  id='compare' style="display: none;">
	<div class="col-md-12">
		<h2>5. Compare</h2>
		<button 
			type="submit"
			class="btn btn-default opReq"
			data-loading-text="<span class='glyphicon glyphicon-refresh glyphicon-spin' aria-hidden='true'></span>" 
			data-done-text="<span style='color: green;' class='glyphicon glyphicon-ok' aria-hidden='true'></span>"
			data-error-text="<span class='glyphicon glyphicon-remove' aria-hidden='true'></span>"
			>compare</button>
	</div>
	</div>

</div>

<script type="text/x-jsrender" id='statRow'>
<tr>
	<td>{{:check}}</td><td>{{:status}}</td>
</tr>
</script>


<script type="text/javascript">

function scrollDown() {
	var n = $(document).height();
	$('html, body').animate({ scrollTop: n }, 2000);
}

function btnDisabled(btn) {
	btn.button('done');
	setTimeout(function(btn) {
		btn.prop('disabled', true);
	}, 100, btn);
	
}

function btnLabel(btn, label) {
	setTimeout(function(btn, label) {
		btn.empty();
		btn.append(label);
	}, 100, btn, label);
}

function importComplete(btn) {
	btnDisabled(btn);
   	$('#importFile').prop('disabled', true);
   	$('#prePublishTests').toggle(true);
   	$('#importFrm').prepend(
		"<span style='color: green;' class='glyphicon glyphicon-ok'></span>"
	);	
}

function preChecksComplete(btn) {
	btnDisabled(btn);
	$('#runDiff').toggle(true);
	scrollDown();
	$.get('diff', function(data) {
		$("#change").empty();
		$("#change").append("<pre>" + data + "</pre>");
		$('#publish').toggle(true);
		scrollDown();
	});
}

$('#submitImportFile').on('click', function(event) {
	event.preventDefault();
	if ($('#importFile')[0].files.length > 0) {
		var btn = $(this);
		btn.button('loading');
		var file = $('#importFile')[0].files[0];
		var data = new FormData();
		data.append("importFile", file);

	    $.ajax({
	        url: 'ctrl',
	        type: 'POST',
	        data: data,
	        cache: false,
	        dataType: 'json',
	        processData: false, // Don't process the files
	        contentType: false, // Set content type to false as jQuery will tell the server its a query string request
	        error: function(jqXHR, textStatus, errorThrown)
	        {
        		btn.button('error');
	        }
	    }).done(function(data, textstatus) {
        	if (textstatus=='success') {
        		importComplete(btn);
        	}
	    });		
	}
});

function processPreChecks(data, btn) { 
	var trTmpl = $.templates('#statRow');
	$.each(data, function(check, status) {
		var statSpan;
		if (status == "ok") {
			statSpan = "<span style='color: green;' class='glyphicon glyphicon-ok'></span>"
		} else {
			statSpan = "<span style='color: red;' class='glyphicon glyphicon-remove'></span>"
		}
		$('#validateResults').append(trTmpl.render({check:check,status:statSpan}));	
	});
	preChecksComplete(btn);
}

function publishOut(outStr) {
	$('#publishOutput').empty();
	$('#publishOutput').append(
		"<pre>" + outStr + "</pre>"
		);
	scrollDown();
}

function processPublish(data, btn) {
	var trTmpl = $.templates('#statRow');
	if (data.status == 'ok') {
		btn.button('reset');
		publishOut(data.pubOut);
		$('#processStatus').empty();
		$('#processStatus').append(trTmpl.render({check: data.pubRunning, status: data.pubStatus}));
		if (data.pubStatus == 'okReady') {
			btnDisabled(btn);
			$('#compare').toggle(true);
			scrollDown();
		} else {
			btnLabel(btn, 'checkPublishStat');
			if (data.pubStatus == "running") {
				setTimeout(function(btn) {
					$.get('ctrl?op=checkPublishStat', function(data) {
						processPublish(data, btn)
					});
				}, 1000, btn);
			}
		}
	}
}

$('button.opReq').on('click', function(event) {
	event.preventDefault();
	var btn = $(this);
	var op = btn.text().trim();
	btn.button('loading');
	$.get( 'ctrl?op=' + op, function(data) {
		if (data.status != 'error') {
			switch (op) {
			case 'prePublishChecks':
				processPreChecks(data, btn);
				break;
			case 'publish':
			case 'checkPublishStat':
				processPublish(data, btn);
				break;
			}
		} else {
			btn.button('error');
		}
	});
});

</script>

</body>
</html>